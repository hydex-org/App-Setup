name: CI Pipeline
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Clone subprojects
      run: |
        mkdir -p src
        cd src
        git clone https://github.com/hydex-org/bridge-custody.git
        git clone https://github.com/hydex-org/hydex-frontend.git
        git clone https://github.com/hydex-org/enclaveenv.git
        git clone https://github.com/hydex-org/frost-pallas.git
        git clone https://github.com/hydex-org/hydexAPI.git
    - name: Debug - Show structure
      run: |
        echo "=== Root ==="
        ls -la
        echo "=== src/ ==="
        ls -la src/
        echo "=== src/bridge-custody/ ==="
        ls -la src/bridge-custody/
        echo "=== Dockerfile content ==="
        cat src/bridge-custody/Dockerfile
      # ... rest of workflow
    - name: Login Dockerhub
      env:
        DOCKER_USERNAME: ${{secrets.DOCKER_USERNAME}}
        DOCKER_PASSWORD: ${{secrets.DOCKER_PASSWORD}}
      run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD

    - name: Build Docker images
      run: docker compose build

    - name: Push all images
      run: |
        docker push ilurdo2022/hydex-bridge-custody:latest
        docker push ilurdo2022/hydex-enclave:latest
        docker push ilurdo2022/hydex-bridge-api:latest